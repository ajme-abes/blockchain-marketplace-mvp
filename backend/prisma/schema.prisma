generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String   @id @default(uuid())
  email              String   @unique
  passwordHash       String
  name               String
  phone              String?
  role               UserRole @default(BUYER)
  address            String?
  languagePreference String   @default("en")
  registrationDate   DateTime @default(now())

  // Relations
  producerProfile      Producer?
  buyerProfile         Buyer?
  orders               Order[]               @relation("UserOrders")
  paymentConfirmations PaymentConfirmation[] @relation("UserPaymentConfirmations")
  notifications        Notification[]
  auditLogs           AuditLog[]
  sessions            Session[]
  ipfsFiles           IPFSMetadata[]

  @@index([email])
  @@index([role])
  @@index([registrationDate])
  @@index([email, role])
  @@map("users")
}

model Producer {
  id                 String             @id @default(uuid())
  businessName       String
  location           String
  verificationStatus VerificationStatus @default(PENDING)

  // Relations
  userId   String    @unique
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  products Product[]

  @@index([verificationStatus])
  @@index([businessName])
  @@index([userId])
  @@map("producers")
}

model Buyer {
  id                     String @id @default(uuid())
  preferredPaymentMethod String @default("CHAPA")

  // Relations
  userId  String   @unique
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders  Order[]  @relation("BuyerOrders")
  reviews Review[]

  @@index([userId])
  @@map("buyers")
}

model Product {
  id                String        @id @default(uuid())
  name              String
  category          String
  price             Float
  quantityAvailable Int
  description       String?
  imageUrl          String?
  status            ProductStatus @default(ACTIVE)
  listingDate       DateTime      @default(now())

  // Relations
  producerId String
  producer   Producer    @relation(fields: [producerId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]
  reviews    Review[]
  ipfsFiles  IPFSMetadata[]

  @@index([name])
  @@index([category])
  @@index([price])
  @@index([status])
  @@index([producerId])
  @@index([listingDate])
  @@index([category, status])
  @@index([price, category])
  @@index([status, listingDate])
  @@map("products")
}

model Order {
  id               String         @id @default(uuid())
  totalAmount      Float
  paymentStatus    PaymentStatus  @default(PENDING)
  deliveryStatus   DeliveryStatus @default(PENDING)
  orderDate        DateTime       @default(now())
  blockchainTxHash String?

  // Relations
  buyerId              String
  buyer                Buyer                 @relation(fields: [buyerId], references: [id], onDelete: Cascade, name: "BuyerOrders")
  userId               String? // For the User relation
  user                 User?                 @relation(fields: [userId], references: [id], name: "UserOrders")
  orderItems           OrderItem[]
  paymentConfirmations PaymentConfirmation[]
  blockchainRecords    BlockchainRecord[]

  @@index([buyerId])
  @@index([paymentStatus])
  @@index([deliveryStatus])
  @@index([orderDate])
  @@index([blockchainTxHash])
  @@index([buyerId, orderDate])
  @@index([paymentStatus, deliveryStatus])
  @@index([orderDate, paymentStatus])
  @@map("orders")
}

model OrderItem {
  id       String @id @default(uuid())
  quantity Int
  subtotal Float

  // Relations
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])

  @@unique([orderId, productId])
  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model PaymentConfirmation {
  id                 String        @id @default(uuid())
  confirmationMethod PaymentMethod
  confirmedAt        DateTime      @default(now())
  proofImageUrl      String?
  blockchainTxHash   String?

  // Relations
  orderId       String
  order         Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  confirmedById String
  confirmedBy   User   @relation(fields: [confirmedById], references: [id], name: "UserPaymentConfirmations")

  @@index([orderId])
  @@index([confirmedById])
  @@index([confirmedAt])
  @@index([confirmationMethod])
  @@map("payment_confirmations")
}

model BlockchainRecord {
  id          String    @id @default(uuid())
  txHash      String    @unique
  blockNumber String?
  timestamp   DateTime?
  status      String    @default("pending")

  // Relations
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([txHash])
  @@index([timestamp])
  @@index([status])
  @@map("blockchain_records")
}

model Review {
  id         String   @id @default(uuid())
  rating     Int // 1-5 stars
  comment    String?
  reviewDate DateTime @default(now())

  // Relations
  buyerId   String
  buyer     Buyer   @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([buyerId, productId])
  @@index([buyerId])
  @@index([productId])
  @@index([rating])
  @@index([reviewDate])
  @@map("reviews")
}

model Notification {
  id        String             @id @default(uuid())
  message   String
  type      NotificationType
  status    NotificationStatus @default(UNREAD)
  createdAt DateTime           @default(now())

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([userId, status])
  @@map("notifications")
}

// NEW MODELS

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  entity    String
  entityId  String
  oldValues Json?
  newValues Json?
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: NoAction)
  ipAddress String?
  userAgent String?
  timestamp DateTime @default(now())
  
  @@index([action])
  @@index([entity, entityId])
  @@index([timestamp])
  @@index([userId])
  @@index([entity, timestamp])
  @@map("audit_logs")
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String   @unique
  refreshToken String?  @unique
  expiresAt    DateTime
  ipAddress    String?
  userAgent    String?
  isValid      Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([token])
  @@index([refreshToken])
  @@index([expiresAt])
  @@index([isValid])
  @@index([createdAt])
  @@index([userId, isValid])
  @@index([expiresAt, isValid])
  @@map("sessions")
}

model IPFSMetadata {
  id        String   @id @default(uuid())
  cid       String   @unique
  name      String?
  mimeType  String?
  size      Int?
  category  IPFSCategory
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: NoAction)
  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: NoAction)
  createdAt DateTime @default(now())

  @@index([cid])
  @@index([category])
  @@index([userId])
  @@index([productId])
  @@index([createdAt])
  @@index([category, createdAt])
  @@map("ipfs_metadata")
}

// ENUMS
enum UserRole {
  BUYER
  PRODUCER
  ADMIN
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  FAILED
  REFUNDED
}

enum DeliveryStatus {
  PENDING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  CHAPA
  ARIFPAY
  MANUAL
}

enum NotificationType {
  ORDER_CREATED
  PAYMENT_CONFIRMED
  ORDER_SHIPPED
  DISPUTE_RAISED
  GENERAL
  SECURITY
  SYSTEM
}

enum NotificationStatus {
  READ
  UNREAD
}

// NEW ENUMS
enum IPFSCategory {
  PRODUCT_IMAGE
  USER_AVATAR
  DOCUMENT
  PAYMENT_PROOF
  BUSINESS_LICENSE
}